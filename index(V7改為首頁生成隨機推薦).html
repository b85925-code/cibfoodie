<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å­¸é•·ï¼Œåˆé¤åƒä»€éº¼ï¼Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- å­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* å¡ç‰‡èˆ‡æŒ‰éˆ•å†æ›´é€æ˜ */
      --bg-card: rgba(255, 255, 255, 0.25);
      --button-bg: rgba(255, 255, 255, 0.20);

      --accent: #1f8ef1;
      --text-main: #222;
      --text-sub-dark: #333;
      --border-soft: rgba(255, 255, 255, 0.45);
      --danger: #ff4d4f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans TC", system-ui;
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    /* èƒŒæ™¯åœ–ç‰‡ */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url("background.jpg") center center / cover no-repeat;
      z-index: -2;
    }

    /* æš—è‰²é®ç½©æé«˜å¯è®€æ€§ */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: -1;
    }

    /* é ‚éƒ¨å°èˆªåˆ—ï¼ˆéœ§ç»ç’ƒï¼‰ */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(18px);
      background: rgba(15, 23, 42, 0.35);
      border-bottom: 1px solid rgba(255, 255, 255, 0.18);
    }

    .nav {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #f9fafb;
    }

    .site-title { font-size: 1.4rem; font-weight: 700; }
    .site-subtitle { font-size: 0.85rem; color: #e5e7eb; }

    .btn-login {
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, 0.6);
      padding: 6px 14px;
      background: rgba(15, 23, 42, 0.55);
      font-size: 0.85rem;
      color: #f9fafb;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-login:hover {
      border-color: white;
      background: rgba(15,23,42,0.8);
    }

    /* ä¸»é«”ï¼šä¸Šä¸‹å…©å¼µå¡ç‰‡ç½®ä¸­ï¼ˆä¸å¯æ”¹å‹•ç‚ºå·¦å³ï¼‰ */
    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px 16px 40px;
    }

    .container {
      max-width: 720px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* å¡ç‰‡éœ§ç»ç’ƒ */
    .card,
    .restaurants-panel {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 24px;
      backdrop-filter: blur(18px);
      border: 1px solid var(--border-soft);
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-main);
    }

    /* å››é¡†é€æ˜æŒ‰éˆ•ï¼šå¯¬åº¦è²¼æ–‡å­— */
    .button-group {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-start; /* è®“æŒ‰éˆ•ä¾æ–‡å­—å¯¬åº¦æ”¶æ–‚ */
    }

    .meal-btn {
      padding: 8px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.55);
      background: var(--button-bg);
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      width: auto;
      max-width: 100%;
      gap: 8px;
      white-space: nowrap;
    }

    .meal-btn:hover {
      background: rgba(255,255,255,0.65);
      border-color: var(--accent);
    }

    .meal-btn .emoji { font-size: 1.15rem; }
    .chevron { color: #444; font-size: 0.9rem; }

    /* é¤å»³å¡ç‰‡å€ */
    .restaurants-title {
      font-size: 1.1rem; /* èˆ‡ã€Œä»Šå¤©è¦åƒä»€éº¼ï¼Ÿã€åŒå¤§å° */
      font-weight: 700;
      color: var(--text-main);
    }

    .restaurants-subtitle {
      font-size: 0.82rem;
      color: var(--text-sub-dark);
    }

    .btn-refresh {
      background: rgba(255,255,255,0.75);
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 0.8rem;
    }

    .btn-refresh:hover {
      background: rgba(255,255,255,0.95);
      color: var(--accent);
    }

    .restaurants-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .restaurant-card {
      border-radius: 16px;
      padding: 10px;
      background: white;
      border: 1px solid rgba(255, 255, 255, 0.85);
      cursor: pointer;
      transition: all 0.15s ease;
      overflow: hidden;
    }

    .restaurant-card:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .restaurant-thumb {
      width: 100%;
      border-radius: 12px;
      display: block;
      margin-bottom: 8px;
      object-fit: cover;
      max-height: 180px;
    }

    .restaurant-name {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .restaurant-address {
      font-size: 0.78rem;
      color: #555;
    }

    .restaurant-meta {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: #666;
    }

    .price-tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.7rem;
    }

    .hint-text {
      font-size: 0.78rem;
      color: var(--text-sub-dark);
    }

    footer {
      font-size: 0.72rem;
      color: #e5e7eb;
      text-align: center;
      padding: 10px 16px 20px;
    }
  </style>

  <!-- Google Maps JavaScript API -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&language=zh-TW&region=TW&callback=initPlaces">
  </script>
</head>

<body>
  <!-- é ‚éƒ¨ -->
  <header>
    <div class="nav">
      <div>
        <div class="site-title">å­¸é•·ï¼Œåˆé¤åƒä»€éº¼ï¼Ÿ</div>
        <div class="site-subtitle">æ¯å¤©æŠ‰æ“‡é‚£éº¼å¤šï¼Œè¦åƒä»€éº¼äº¤çµ¦æˆ‘</div>
      </div>
      <button class="btn-login" id="btnLogin">ç™»å…¥</button>
    </div>
  </header>

  <!-- ä¸»é«”ï¼ˆä¸Šä¸‹å…©å¼µå¡ç‰‡ï¼Œä¸æ”¹æˆå·¦å³ï¼‰ -->
  <main>
    <div class="container">

      <!-- ä¸Šï¼šå››é¡†æŒ‰éˆ• -->
      <section class="card">
        <div class="card-title">ä»Šå¤©è¦åƒä»€éº¼ï¼Ÿï¼ˆéš¨æ©Ÿæ¨è–¦ï¼‰</div>

        <div class="button-group">
          <button class="meal-btn" id="btnBreakfast">
            <span class="label"><span class="emoji">ğŸŒ…</span> æ—©é¤åƒä»€éº¼ï¼Ÿ</span>
            <span class="chevron">â–¶</span>
          </button>

          <button class="meal-btn" id="btnLunch">
            <span class="label"><span class="emoji">ğŸ±</span> åˆé¤åƒä»€éº¼ï¼Ÿ</span>
            <span class="chevron">â–¶</span>
          </button>

          <button class="meal-btn" id="btnDinner">
            <span class="label"><span class="emoji">ğŸŒ™</span> æ™šé¤åƒä»€éº¼ï¼Ÿ</span>
            <span class="chevron">â–¶</span>
          </button>

          <button class="meal-btn" id="btnDuty">
            <span class="label"><span class="emoji">ğŸš”</span> åŸ·è¡Œæ¡ˆä»¶åƒä»€éº¼ï¼Ÿ</span>
            <span class="chevron">â–¶</span>
          </button>
        </div>
      </section>

      <!-- ä¸‹ï¼šé¤å»³åˆ—è¡¨ -->
      <section class="restaurants-panel">
        <div class="restaurants-header" style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div class="restaurants-title">æ¯æ—¥ç²¾é¸</div>
            <div class="restaurants-subtitle">ä¾ç›®å‰æ™‚é–“é¡¯ç¤ºé™„è¿‘å¯ç”¨é¤çš„åº—å®¶</div>
          </div>
          <button class="btn-refresh" id="btnRefresh">é‡æ–°æŠ½åº—å®¶</button>
        </div>

        <div id="restaurantsStatus" class="status-message" style="margin-top:8px;">
          æ­£åœ¨è¼‰å…¥é™„è¿‘åº—å®¶â€¦
        </div>

        <div class="restaurants-list" id="restaurantsList"></div>

        <div class="restaurants-footer" style="margin-top:12px; text-align:right;">
          <span class="hint-text">é»æ“Šå¡ç‰‡å³å¯é–‹å•Ÿ Google Maps å•†å®¶é é¢</span>
        </div>
      </section>

    </div>
  </main>

  <footer>
    æœ¬é åƒ…æä¾›é¤é£²å»ºè­°è³‡è¨Šï¼Œå¯¦éš›è³‡è¨Šè«‹ä»¥åº—å®¶å…¬å‘Šç‚ºæº–ã€‚
  </footer>

  <!-- JSï¼šé‚è¼¯åŠŸèƒ½ -->
  <script>
    const CENTER_COORD = { lat: 25.042425, lng: 121.562487 };
    const SEARCH_RADIUS_METERS = 500;

    const PRICE_TIERS = {
      TIER_1: { label: "0â€“200 å…ƒ", className: "tier-1" },
      TIER_2: { label: "200â€“400 å…ƒ", className: "tier-2" },
      TIER_3: { label: "400 å…ƒä»¥ä¸Š", className: "tier-3" }
    };

    let placesService = null;
    let currentMode = "normal"; // normal or duty

    function initPlaces() {
      try {
        const mapDiv = document.createElement('div');
        mapDiv.style.display = 'none';
        document.body.appendChild(mapDiv);

        const dummyMap = new google.maps.Map(mapDiv, { center: CENTER_COORD, zoom: 16 });
        placesService = new google.maps.places.PlacesService(dummyMap);

        // é è¨­è¼‰å…¥ä¸€èˆ¬æ¨¡å¼
        fetchRestaurantsForMode("normal");
      } catch (e) {
        showStatusError("ç„¡æ³•è¼‰å…¥ Google Maps è³‡è¨Šã€‚");
      }
    }

    const restaurantsListEl = document.getElementById('restaurantsList');
    const restaurantsStatusEl = document.getElementById('restaurantsStatus');

    function showStatusMessage(msg){
      restaurantsStatusEl.style.color = "#f9fafb";
      restaurantsStatusEl.textContent = msg;
    }
    function showStatusError(msg){
      restaurantsStatusEl.textContent = msg;
      restaurantsStatusEl.style.color = "#ff4d4f";
    }
    function clearRestaurantsList(){ restaurantsListEl.innerHTML = ""; }

    function isLikelyDrinkShop(place){
      const name = (place.name || "").toLowerCase();
      return ["é£²æ–™","å¥¶èŒ¶","æ‰‹æ–","tea","coffee","å’–å•¡"].some(k => name.includes(k));
    }

    function mapToPriceTier(place){
      const lvl = place.price_level;
      if (lvl === 0 || lvl === 1) return "TIER_1";        // 0â€“200
      if (lvl === 2) return "TIER_2";                      // 200â€“400
      if (lvl === 3 || lvl === 4) return "TIER_3";         // 400+

      // æ²’æœ‰åƒ¹æ ¼è³‡è¨Šæ™‚ï¼Œç”¨è©•åˆ†å¤§è‡´æ¨ä¼°
      const rating = place.rating || 0;
      if (rating >= 4.4) return "TIER_3";
      if (rating >= 4.0) return "TIER_2";
      return "TIER_1";
    }

    function buildMapsUrl(place){
      return place.place_id
        ? `https://www.google.com/maps/place/?q=place_id:${place.place_id}`
        : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}`;
    }

    function nearbyRestaurantsPromise(){
      return new Promise((resolve,reject)=>{
        if(!placesService) return reject("Places API å°šæœªæº–å‚™å¥½");
        placesService.nearbySearch({
          location: CENTER_COORD,
          radius: SEARCH_RADIUS_METERS,
          type:["restaurant"],
          openNow:true,
          language:"zh-TW"
        },(res,status)=>{
          if(status!=="OK") return reject(status);
          resolve(res.filter(p=>!isLikelyDrinkShop(p)));
        });
      });
    }

    // ä¸€èˆ¬æ¨¡å¼ï¼šä¸‰å€‹åƒ¹ä½å„é¸ä¸€é–“ï¼Œè‹¥ä¸è¶³ç”¨å…¶ä»–åƒ¹ä½è£œé½Šï¼Œä¸¦ä¾åƒ¹ä½ä½â†’é«˜æ’åº
    function selectNormalRestaurants(buckets) {
      const order = ["TIER_1", "TIER_2", "TIER_3"]; // ä½â†’é«˜
      const selected = [];
      const used = new Set();

      // å…ˆæ¯å€‹åƒ¹ä½å„æŒ‘ä¸€é–“ï¼ˆè‹¥æœ‰ï¼‰
      order.forEach(tier => {
        const arr = buckets[tier];
        if (arr && arr.length > 0) {
          const idx = Math.floor(Math.random() * arr.length);
          const place = arr[idx];
          selected.push({ tier, place });
          used.add(place.place_id || place.name);
        }
      });

      // å¦‚æœä¸è¶³ä¸‰é–“ï¼Œç”¨æ‰€æœ‰åº—å®¶è£œåˆ° 3 é–“
      const allPlaces = [...buckets.TIER_1, ...buckets.TIER_2, ...buckets.TIER_3];
      while (selected.length < 3 && allPlaces.length > 0) {
        const candidate = allPlaces[Math.floor(Math.random() * allPlaces.length)];
        const key = candidate.place_id || candidate.name;
        if (!used.has(key)) {
          const tier = mapToPriceTier(candidate);
          selected.push({ tier, place: candidate });
          used.add(key);
        } else {
          // é¿å…æ­»å¾ªç’°ï¼Œç§»é™¤ä¸€å€‹å€™é¸
          allPlaces.splice(allPlaces.indexOf(candidate), 1);
        }
      }

      // ä¾åƒ¹ä½ä½â†’é«˜æ’åºè¼¸å‡º
      selected.sort((a, b) => order.indexOf(a.tier) - order.indexOf(b.tier));
      return selected;
    }

    // åŸ·è¡Œæ¡ˆä»¶æ¨¡å¼ï¼šåªé¸ 0â€“200 å…ƒ (TIER_1) ä»»æ„ä¸‰é–“
    function selectDutyRestaurants(buckets) {
      const list = buckets.TIER_1 || [];
      const result = [];
      const copy = [...list];

      while (result.length < 3 && copy.length > 0) {
        const idx = Math.floor(Math.random() * copy.length);
        const place = copy.splice(idx, 1)[0];
        result.push({ tier: "TIER_1", place });
      }
      return result;
    }

    async function fetchRestaurantsForMode(mode = "normal"){
      currentMode = mode;
      clearRestaurantsList();
      showStatusMessage("æ­£åœ¨è¼‰å…¥é™„è¿‘åº—å®¶â€¦");

      try{
        const places = await nearbyRestaurantsPromise();
        if(!places.length) {
          showStatusError("ç›®å‰æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤é£²åº—ã€‚");
          return;
        }

        // æ‰“äº‚é †åºå†åˆ†æ¡¶
        const shuffled = places.sort(()=>Math.random()-0.5);
        const buckets = { TIER_1:[], TIER_2:[], TIER_3:[] };
        shuffled.forEach(p=> buckets[mapToPriceTier(p)].push(p));

        let selected = [];
        if (mode === "duty") {
          selected = selectDutyRestaurants(buckets);
          if (!selected.length) {
            showStatusError("ç›®å‰é™„è¿‘æ‰¾ä¸åˆ° 0â€“200 å…ƒçš„é¤é£²åº—ã€‚");
            return;
          }
        } else {
          selected = selectNormalRestaurants(buckets);
          if (!selected.length) {
            showStatusError("è³‡æ–™ä¸è¶³ï¼Œç¨å¾Œå†è©¦ã€‚");
            return;
          }
        }

        renderRestaurants(selected);
        showStatusMessage("å·²ç‚ºä½ æŒ‘é¸ä¸‰é–“é¤é£²åº—ã€‚");
      } catch(e){
        showStatusError("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚");
      }
    }

    function renderRestaurants(selected){
      clearRestaurantsList();

      selected.forEach(({tier,place})=>{
        const card = document.createElement("div");
        card.className = "restaurant-card";

        // Google Maps ç¸®åœ–
        if (place.photos && place.photos.length > 0) {
          const img = document.createElement("img");
          img.className = "restaurant-thumb";
          img.src = place.photos[0].getUrl({ maxWidth: 400, maxHeight: 200 });
          img.alt = place.name;
          card.appendChild(img);
        }

        const name = document.createElement("div");
        name.className = "restaurant-name";
        name.textContent = place.name;

        const address = document.createElement("div");
        address.className = "restaurant-address";
        address.textContent = place.vicinity || "åœ°å€æœªæä¾›";

        const meta = document.createElement("div");
        meta.className = "restaurant-meta";

        const ratingText = document.createElement("span");
        ratingText.textContent = place.rating ? `è©•åˆ†ï¼š${place.rating.toFixed(1)}â˜…` : "å°šç„¡è©•åˆ†";

        const priceTag = document.createElement("span");
        priceTag.className = "price-tag";
        priceTag.textContent = PRICE_TIERS[tier]?.label || "åƒ¹æ ¼æœªåˆ†é¡";

        meta.appendChild(ratingText);
        meta.appendChild(priceTag);

        card.appendChild(name);
        card.appendChild(address);
        card.appendChild(meta);

        card.addEventListener("click",()=>{
          window.open(buildMapsUrl(place),"_blank","noopener");
        });

        restaurantsListEl.appendChild(card);
      });
    }

    // é‡æ–°æŠ½åº—å®¶ï¼šæ²¿ç”¨ç›®å‰æ¨¡å¼
    document.getElementById("btnRefresh").onclick = () => fetchRestaurantsForMode(currentMode);
    document.getElementById("btnLogin").onclick = ()=>alert("ç™»å…¥åŠŸèƒ½é–‹ç™¼ä¸­");

    // ä¸‰é¤ + åŸ·è¡Œæ¡ˆä»¶æŒ‰éˆ•
    document.getElementById("btnBreakfast").onclick = () => {
      fetchRestaurantsForMode("normal");
      alert("å·²ä¾ã€æ—©é¤æ¨¡å¼ã€‘é‡æ–°æ¨è–¦é¤å»³ï¼");
    };
    document.getElementById("btnLunch").onclick = () => {
      fetchRestaurantsForMode("normal");
      alert("å·²ä¾ã€åˆé¤æ¨¡å¼ã€‘é‡æ–°æ¨è–¦é¤å»³ï¼");
    };
    document.getElementById("btnDinner").onclick = () => {
      fetchRestaurantsForMode("normal");
      alert("å·²ä¾ã€æ™šé¤æ¨¡å¼ã€‘é‡æ–°æ¨è–¦é¤å»³ï¼");
    };
    document.getElementById("btnDuty").onclick = () => {
      fetchRestaurantsForMode("duty");
      alert("å·²ä¾ã€åŸ·è¡Œæ¡ˆä»¶æ¨¡å¼ã€‘é‡æ–°æ¨è–¦é¤å»³ï¼ï¼ˆåƒ… 0â€“200 å…ƒï¼‰");
    };

    // æä¾›çµ¦ Google Maps callback ä½¿ç”¨
    window.initPlaces = initPlaces;
  </script>
</body>
</html>
