<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å­¸é•·ï¼Œåˆé¤åƒä»€éº¼ï¼Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- å­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Maps JSï¼ˆæ­é… Places New ä½¿ç”¨ï¼‰ -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsgevBWyNHGA7GJN9ENKINDRM2g5dBj1I&language=zh-TW&region=TW"></script>

  <style>
    :root {
      --bg-card: rgba(255, 255, 255, 0.33);
      --button-bg: rgba(255, 255, 255, 0.30);
      --accent: #1f8ef1;
      --text-main: #222;
      --text-sub-dark: #333;
      --border-soft: rgba(255, 255, 255, 0.45);
      --bubble-bg: #c5f7a4; /* é¡ä¼¼ LINE ç¶ è‰²æ³¡æ³¡ */
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans TC", system-ui;
      color: var(--text-main);
      background: #000;
      min-height: 100vh;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url("background.jpg") center/cover no-repeat;
      z-index: -2;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: -1;
    }

    header {
      position: sticky; top: 0;
      backdrop-filter: blur(18px);
      background: rgba(15, 23, 42, 0.35);
      padding: 12px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1.2rem;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 5;
    }

    .site-title { font-size: 1.1rem; font-weight: 700; }
    .site-subtitle { font-size: 0.8rem; color: #e5e7eb; }

    .btn-login {
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, 0.6);
      padding: 6px 14px;
      background: rgba(15, 23, 42, 0.55);
      font-size: 0.85rem;
      color: #f9fafb;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-login:hover {
      border-color: white;
      background: rgba(15,23,42,0.8);
    }

    main {
      padding: 24px 16px 40px;
      max-width: 720px;
      margin: auto;
    }

    .card, .restaurants-panel {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 24px;
      backdrop-filter: blur(16px);
      border: 1px solid var(--border-soft);
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-main);
    }

    .button-group {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .meal-btn {
      background: var(--button-bg);
      border: 1px solid rgba(255,255,255,0.65);
      padding: 10px 14px;
      border-radius: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      max-width: 260px;  /* å¯¬åº¦è²¼æ–‡å­— */
      font-size: 0.95rem;
    }

    .restaurants-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 4px;
    }

    #restaurantsStatus {
      font-size: 0.9rem;
      margin: 6px 0 10px;
      color: #fff;
    }

    /* ============ å•†å®¶é è¦½æ³¡æ³¡ ============ */

    .place-bubble {
      background: var(--bubble-bg);
      border-radius: 16px;
      padding: 8px 10px 10px;
      margin-bottom: 12px;
      position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }

    .place-bubble::after {
      content: "";
      position: absolute;
      left: 12px;
      bottom: -8px;
      border-width: 8px 8px 0 0;
      border-style: solid;
      border-color: var(--bubble-bg) transparent transparent transparent;
    }

    .place-link-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      gap: 6px;
    }

    .place-link {
      font-size: 0.8rem;
      color: #005bb5;
      text-decoration: underline;
      word-break: break-all;
      flex: 1;
      cursor: pointer;
    }

    .btn-copy {
      border: none;
      background: rgba(255,255,255,0.8);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn-copy:hover {
      background: #fff;
    }

    .place-preview {
      background: #fff;
      border-radius: 10px;
      padding: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      cursor: pointer;
    }

    .place-info {
      flex: 1;
      min-width: 0;
    }

    .place-name {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .place-address {
      font-size: 0.78rem;
      color: #555;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .place-meta {
      font-size: 0.75rem;
      color: #777;
    }

    .place-photo {
      width: 68px;
      height: 68px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      background: #eee;
    }

    .btn-refresh {
      margin-top: 10px;
      background: var(--button-bg);
      border: 1px solid rgba(255,255,255,0.65);
      padding: 8px 14px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-refresh:hover {
      background: rgba(255,255,255,0.8);
    }
  </style>
</head>

<body>
<header>
  <div>
    <div class="site-title">å­¸é•·ï¼Œåˆé¤åƒä»€éº¼ï¼Ÿ</div>
    <div class="site-subtitle">æ¯å¤©æŠ‰æ“‡é‚£éº¼å¤šï¼Œè¦åƒä»€éº¼äº¤çµ¦æˆ‘</div>
  </div>
  <button class="btn-login">ç™»å…¥</button>
</header>

<main>

  <!-- ä¸Šï¼šå››é¡†æŒ‰éˆ• -->
  <section class="card">
    <div class="card-title">ä»Šå¤©è¦åƒä»€éº¼ï¼Ÿï¼ˆéš¨æ©Ÿæ¨è–¦ï¼‰</div>

    <div class="button-group">
      <button class="meal-btn" id="btnBreakfast">ğŸŒ… æ—©é¤åƒä»€éº¼ï¼Ÿ</button>
      <button class="meal-btn" id="btnLunch">ğŸ± åˆé¤åƒä»€éº¼ï¼Ÿ</button>
      <button class="meal-btn" id="btnDinner">ğŸŒ™ æ™šé¤åƒä»€éº¼ï¼Ÿ</button>
      <button class="meal-btn" id="btnDuty">ğŸš” åŸ·è¡Œæ¡ˆä»¶åƒä»€éº¼ï¼Ÿ</button>
    </div>
  </section>

  <!-- ä¸‹ï¼šæ¯æ—¥ç²¾é¸é è¦½å¡ -->
  <section class="restaurants-panel">
    <div class="restaurants-title">æ¯æ—¥ç²¾é¸</div>
    <div id="restaurantsStatus">æ­£åœ¨è¼‰å…¥é™„è¿‘åº—å®¶â€¦</div>
    <div id="restaurantsList"></div>
    <button id="btnRefresh" class="btn-refresh">é‡æ–°æŠ½åº—å®¶</button>
  </section>

</main>

<script>
  const API_KEY = "AIzaSyDsgevBWyNHGA7GJN9ENKINDRM2g5dBj1I";
  const CENTER = { lat: 25.042425, lng: 121.562487 };
  const RADIUS_M = 500;

  let PlaceAPI = null;
  let currentMode = "normal"; // normal / duty

  const statusEl = document.getElementById("restaurantsStatus");
  const listEl = document.getElementById("restaurantsList");

  function setStatus(msg, isError = false) {
    statusEl.style.color = isError ? "#ff4d4f" : "#ffffff";
    statusEl.textContent = msg;
  }

  function isDrink(place) {
    const n = (place.displayName?.text || "").toLowerCase();
    return ["é£²æ–™","å¥¶èŒ¶","tea","coffee","å’–å•¡","æ‰‹æ–"].some(k => n.includes(k));
  }

  function getTier(place) {
    const lv = place.priceLevel;
    if (lv === 0 || lv === 1) return "TIER_1";      // 0â€“200
    if (lv === 2) return "TIER_2";                  // 200â€“400
    if (lv === 3 || lv === 4) return "TIER_3";      // 400+
    const rating = place.rating || 0;
    if (rating >= 4.4) return "TIER_3";
    if (rating >= 4.0) return "TIER_2";
    return "TIER_1";
  }

  function tierLabel(tier) {
    if (tier === "TIER_1") return "0â€“200 å…ƒ";
    if (tier === "TIER_2") return "200â€“400 å…ƒ";
    if (tier === "TIER_3") return "400 å…ƒä»¥ä¸Š";
    return "æœªåˆ†é¡";
  }

  function buildMapsUrl(place) {
    if (place.googleMapsUri) return place.googleMapsUri;
    if (place.id) return `https://www.google.com/maps/place/?q=place_id:${place.id}`;
    return "https://maps.google.com/";
  }

  function buildPhotoUrl(place) {
    const photo = place.photos && place.photos[0];
    if (!photo || !photo.name) return null;
    const encodedName = encodeURIComponent(photo.name);
    return `https://places.googleapis.com/v1/${encodedName}/media?key=${API_KEY}&maxWidthPx=300&maxHeightPx=300`;
  }

  async function searchNearbyPlaces() {
    if (!PlaceAPI) throw new Error("Places API å°šæœªæº–å‚™å¥½");

    const request = {
      fields: [
        "id",
        "displayName",
        "formattedAddress",
        "googleMapsUri",
        "priceLevel",
        "rating",
        "types",
        "photos"
      ],
      locationRestriction: {
        center: CENTER,
        radius: RADIUS_M
      },
      includedPrimaryTypes: ["restaurant"],
      isOpenNow: true,
      language: "zh-TW",
      maxResultCount: 60
    };

    const { places } = await PlaceAPI.searchNearby(request);
    return (places || []).filter(p => !isDrink(p));
  }

  function randomPick(arr, count) {
    const copy = [...arr];
    const result = [];
    while (copy.length && result.length < count) {
      const idx = Math.floor(Math.random() * copy.length);
      result.push(copy.splice(idx, 1)[0]);
    }
    return result;
  }

  function renderPlaces(selected) {
    listEl.innerHTML = "";

    selected.forEach(({ tier, place }) => {
      const bubble = document.createElement("div");
      bubble.className = "place-bubble";

      const mapsUrl = buildMapsUrl(place);
      const photoUrl = buildPhotoUrl(place);

      // ä¸Šé¢ï¼šå¯è¤‡è£½é€£çµåˆ—
      const linkRow = document.createElement("div");
      linkRow.className = "place-link-row";

      const linkText = document.createElement("div");
      linkText.className = "place-link";
      linkText.textContent = mapsUrl;
      linkText.onclick = () => window.open(mapsUrl, "_blank", "noopener");

      const copyBtn = document.createElement("button");
      copyBtn.className = "btn-copy";
      copyBtn.textContent = "è¤‡è£½é€£çµ";
      copyBtn.onclick = async (e) => {
        e.stopPropagation();
        try {
          await navigator.clipboard.writeText(mapsUrl);
          copyBtn.textContent = "å·²è¤‡è£½";
          setTimeout(() => (copyBtn.textContent = "è¤‡è£½é€£çµ"), 1200);
        } catch {
          alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–é€£çµ");
        }
      };

      linkRow.appendChild(linkText);
      linkRow.appendChild(copyBtn);

      // ä¸‹æ–¹ï¼šé è¦½å¡
      const preview = document.createElement("div");
      preview.className = "place-preview";

      const info = document.createElement("div");
      info.className = "place-info";

      const nameEl = document.createElement("div");
      nameEl.className = "place-name";
      nameEl.textContent = place.displayName?.text || "åº—åæœªæä¾›";

      const addrEl = document.createElement("div");
      addrEl.className = "place-address";
      addrEl.textContent = place.formattedAddress || "åœ°å€æœªæä¾›";

      const metaEl = document.createElement("div");
      metaEl.className = "place-meta";
      const rating = place.rating ? `${place.rating.toFixed(1)}â˜…` : "å°šç„¡è©•åˆ†";
      metaEl.textContent = `${rating} Â· ${tierLabel(tier)}`;

      info.appendChild(nameEl);
      info.appendChild(addrEl);
      info.appendChild(metaEl);

      const imgEl = document.createElement("img");
      imgEl.className = "place-photo";
      if (photoUrl) {
        imgEl.src = photoUrl;
        imgEl.alt = place.displayName?.text || "é¤å»³ç…§ç‰‡";
      }

      preview.appendChild(info);
      preview.appendChild(imgEl);

      preview.onclick = () => window.open(mapsUrl, "_blank", "noopener");

      bubble.appendChild(linkRow);
      bubble.appendChild(preview);

      listEl.appendChild(bubble);
    });
  }

  async function fetchRestaurants() {
    setStatus("æ­£åœ¨è¼‰å…¥é™„è¿‘åº—å®¶â€¦");
    listEl.innerHTML = "";

    try {
      const all = await searchNearbyPlaces();
      if (!all.length) {
        setStatus("ç›®å‰æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é¤é£²åº—ã€‚", true);
        return;
      }

      const buckets = { TIER_1: [], TIER_2: [], TIER_3: [] };
      all.forEach(p => {
        const t = getTier(p);
        buckets[t].push(p);
      });

      let selected = [];

      if (currentMode === "duty") {
        // åŸ·è¡Œæ¡ˆä»¶ï¼šåªæŠ½ 0â€“200 å…ƒä¸‰é–“
        if (!buckets.TIER_1.length) {
          setStatus("é™„è¿‘æ²’æœ‰ç¬¦åˆ 0â€“200 å…ƒçš„é¤é£²åº—ã€‚", true);
          return;
        }
        selected = randomPick(buckets.TIER_1, 3).map(p => ({ tier: "TIER_1", place: p }));
      } else {
        // ä¸€èˆ¬ä¸‰é¤ï¼šä¸‰å€‹åƒ¹ä½å„æŠ½ä¸€é–“ï¼ˆè‹¥æœ‰ï¼‰
        const order = ["TIER_1", "TIER_2", "TIER_3"];
        order.forEach(t => {
          if (buckets[t].length) {
            const p = buckets[t][Math.floor(Math.random() * buckets[t].length)];
            selected.push({ tier: t, place: p });
          }
        });
      }

      if (!selected.length) {
        setStatus("è³‡æ–™ä¸è¶³ï¼Œç¨å¾Œå†è©¦ã€‚", true);
        return;
      }

      // åƒ¹ä½ä½åˆ°é«˜æ’åº
      const orderMap = { TIER_1: 1, TIER_2: 2, TIER_3: 3 };
      selected.sort((a, b) => orderMap[a.tier] - orderMap[b.tier]);

      renderPlaces(selected);
      setStatus("å·²ç‚ºä½ æŒ‘é¸ä¸‰é–“é¤é£²åº—ã€‚");
    } catch (e) {
      console.error(e);
      setStatus("è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Places API è¨­å®šã€‚", true);
    }
  }

  async function initPlaces() {
    try {
      const { Place } = await google.maps.importLibrary("places");
      PlaceAPI = Place;
      fetchRestaurants();
    } catch (e) {
      console.error(e);
      setStatus("ç„¡æ³•åˆå§‹åŒ– Places APIï¼Œè«‹ç¢ºèªå·²å•Ÿç”¨ Places API (New)ã€‚", true);
    }
  }

  // ç¶å®šæŒ‰éˆ•
  document.getElementById("btnBreakfast").onclick = () => { currentMode = "normal"; fetchRestaurants(); };
  document.getElementById("btnLunch").onclick    = () => { currentMode = "normal"; fetchRestaurants(); };
  document.getElementById("btnDinner").onclick   = () => { currentMode = "normal"; fetchRestaurants(); };
  document.getElementById("btnDuty").onclick     = () => { currentMode = "duty";   fetchRestaurants(); };
  document.getElementById("btnRefresh").onclick  = () => fetchRestaurants();

  window.addEventListener("load", initPlaces);
</script>

</body>
</html>
